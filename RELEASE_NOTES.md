# PRISM-INSIGHT 릴리즈 노트

## v1.3.0 (2025-11-04)

### 🚨 중요 보안 및 안정성 패치

**이슈**: 2025년 11월 4일 오전 9:30 crontab 실행 시, MCP 서버 연결 실패로 인해 잘못된 데이터로 분석 및 매매 시그널이 발행되는 치명적 결함 발견

#### 발견된 문제
- **종목**: HLB글로벌(003580)
- **실제 가격**: 2,520원 (오전 9:48 시점)
- **분석된 가격**: 8,500원
- **오차율**: 337% (3.37배)
- **근본 원인**: MCP 서버 `kospi_kosdaq` 연결 실패 시에도 AI가 할루시네이션으로 2년치 주가 데이터를 생성하여 보고서 작성

#### 심각성
- ⚠️ **CRITICAL**: 잘못된 데이터 기반 투자 전략 생성
- ⚠️ **CRITICAL**: 부정확한 매수/매도 시그널 발행 (8,000원/7,500원 매수 권장 vs 실제가 2,520원)
- ⚠️ **HIGH**: 데이터 소스 실패를 warning으로만 처리하고 계속 진행

---

### ✨ 새로운 기능

#### 1. 데이터 신뢰성 보장 시스템
- **Fail-Fast 정책**: 필수 MCP 서버 연결 실패 시 즉시 분석 중단
- **데이터 검증 레이어**: 모든 섹션 보고서 데이터 자동 검증
- **가격 Cross-Validation**: 트리거 가격과 분석 가격 일치성 검증 (허용 오차 10%)

#### 2. 실시간 알람 시스템
- **Telegram 긴급 알람**: 데이터 소스 실패, 검증 실패 시 즉시 알림
- **상세한 에러 로깅**: 문제 추적 및 디버깅 용이성 대폭 향상

#### 3. 보고서 품질 정보
- **데이터 품질 메타데이터**: 모든 보고서에 데이터 소스 상태 및 신뢰도 점수 표시
- **투명성 강화**: 어떤 데이터 소스가 사용되었는지 명확히 표시

---

### 🔧 기술적 개선

#### 새로운 모듈
```
cores/exceptions.py          # 커스텀 예외 클래스
cores/data_validator.py       # 데이터 검증 유틸리티
cores/telegram_alert.py       # 긴급 알람 시스템
```

#### 수정된 파일
- `cores/analysis.py`: MCP 서버 사전 점검, 데이터 검증, 메타데이터 추가
- `stock_analysis_orchestrator.py`: 가격 Cross-Validation 로직 추가

#### 주요 함수
- `verify_mcp_server_health()`: MCP 서버 연결 상태 확인
- `validate_report_data()`: 보고서 내용 검증 (할루시네이션 방지)
- `validate_analysis_price()`: 트리거 가격 vs 분석 가격 검증
- `send_telegram_alert()`: 긴급 상황 즉시 알림

---

### 🐛 수정된 버그

1. **[CRITICAL] MCP 서버 실패 시 할루시네이션 문제**
   - 이전: 연결 실패 시에도 AI가 상상으로 데이터 생성
   - 수정: 연결 실패 시 즉시 `CriticalDataSourceError` 발생 및 분석 중단

2. **[HIGH] 가격 데이터 불일치 감지 불가**
   - 이전: 트리거 가격과 분석 가격 비교 로직 없음
   - 수정: 10% 이상 차이 시 `PriceDataMismatchError` 발생 및 보고서 폐기

3. **[MEDIUM] 데이터 출처 불명확**
   - 이전: 어떤 데이터 소스가 사용되었는지 알 수 없음
   - 수정: 모든 보고서에 데이터 품질 메타데이터 섹션 추가

4. **[MEDIUM] 에러 발생 시 알림 부재**
   - 이전: 로그 파일에만 기록
   - 수정: Telegram 즉시 알람 전송

---

### 📊 영향

#### 긍정적 영향
- ✅ **데이터 신뢰성 100% 보장**: 불완전한 데이터로 분석 진행 불가
- ✅ **잘못된 매매 리스크 제거**: 가격 불일치 시 보고서 저장 안 함
- ✅ **즉각적인 문제 인지**: Telegram 알람으로 실시간 모니터링
- ✅ **투명성 강화**: 데이터 품질 정보를 보고서에 명시

#### 주의사항
- ⚠️ MCP 서버 연결 불안정 시 분석이 더 자주 실패할 수 있음 (의도된 동작)
- ⚠️ Telegram 설정이 없으면 알람 기능 비활성화됨

---

### 🔄 마이그레이션 가이드

#### 기존 사용자
1. **자동 적용**: 코드 업데이트 후 별도 설정 불필요
2. **Telegram 알람 활성화 (선택사항)**:
   ```bash
   # .env 파일에 추가
   TELEGRAM_BOT_TOKEN=your_bot_token
   TELEGRAM_CHAT_ID=your_chat_id
   ```

#### 시스템 요구사항
- Python 3.x
- `python-telegram-bot` 라이브러리 (알람 기능 사용 시)
  ```bash
  pip install python-telegram-bot
  ```

---

### 🙏 기여자
- **Claude (Anthropic)**: 데이터 검증 시스템 설계 및 구현

---

### 📝 관련 커밋
- c4545ae: fix: MCP 서버 연결 실패 시 데이터 신뢰성 보장 시스템 구축

---

## 이전 버전

### v1.2.0 (2025-10-27)
- 주문가능금액 0원 문제 수정
- DB-계좌 동기화 개선

### v1.1.0
- 텔레그램 방 비활성화 기능 추가
- 동적 모드 및 API 클라이언트 재사용

### v1.0.0
- 초기 릴리즈
- 12개 AI 에이전트 기반 주식 분석 시스템
