# Release Notes v1.2.0

**릴리즈 날짜**: 2025-11-03
**릴리즈 타입**: 🐛 버그 수정 (Patch Release)

---

## 🎯 주요 개선사항

이번 릴리즈는 **주문가능금액이 0원으로 잘못 표시되어 매수 불가 상태가 되는 심각한 버그**를 수정합니다.

### 🐛 버그 수정: 주문가능금액 계산 오류

**문제 상황**:
- 계좌에 현금 잔고가 충분히 있음에도 불구하고 주문가능금액이 0원으로 표시
- 텔레그램으로 "매수 불가" 알림이 발생하여 실제 매매 기회 상실
- 오후 스케줄 실행 시 3개 종목 모두 매수 거부됨

**근본 원인**:
- KIS API의 `ord_psbl_cash` 필드를 사용하여 주문가능금액 조회
- 해당 필드는 D+2 예수금 기준으로 계산되어, 매도 후 정산 대기 중인 경우 0원 반환
- 가수도 정산 금액(`prvs_rcdl_excc_amt`)이 반영되지 않아 실제 사용 가능한 현금을 놓침

**해결 방법**:
- `prvs_rcdl_excc_amt` (가수도 정산 금액) 필드로 변경
- D+2 정산 대기 중인 매도 대금도 즉시 재매수에 활용 가능
- 더 적극적이고 효율적인 자금 운용 실현

**효과**:
- ✅ 주문가능금액 정확한 계산: 0원 → 1,031,195원
- ✅ 매수 기회 놓치지 않음
- ✅ 매도 후 즉시 재매수 가능 (자금 회전율 향상)

---

## 📊 변경 내역

### 변경 파일
- `trading/domestic_stock_trading.py`
  - `get_account_summary()` 메서드 수정
  - 주문가능금액 계산 로직 개선
  - KIS API 필드별 상세 주석 추가 (향후 유지보수 편의성 향상)

### 커밋
- `c61a8b5` - fix: 주문가능금액 0원으로 표시되어 매수 불가 문제 수정

---

## 🔍 기술적 세부사항

### KIS API 필드 이해

| 필드명 | 설명 | 이전 사용 | 현재 사용 |
|--------|------|-----------|-----------|
| `ord_psbl_cash` | D+2 예수금 기준 주문가능현금 | ✅ | ❌ |
| `dnca_tot_amt` | 예수금 총액 (실제 정산된 현금) | ❌ | ❌ |
| `prvs_rcdl_excc_amt` | 가수도 정산 금액 (D+2 정산 대기 포함) | ❌ | ✅ |

### 실제 테스트 결과

**수정 전** (2025-11-03 16:13):
```
계좌 요약: 총평가 1,051,345원, 손익 +1,230원 (+6.50%)
주문가능금액: 0원
매수 예정 금액: 200,000원
❌ 주문가능금액 부족: 0원 < 200,000원
매수 보류: SK하이닉스(000660) - 잔고 부족
매수 보류: 디아이씨(092200) - 잔고 부족
매수 보류: 일동홀딩스(000230) - 잔고 부족
```

**수정 후** (2025-11-03 16:36):
```
계좌 요약: 총평가 1,051,345원, 손익 +1,230원 (+6.50%)
주문가능금액: 1,031,195원
✅ 매수 가능
```

---

## ⚠️ 주의사항

### Breaking Changes
없음 (하위 호환성 유지)

### 업그레이드 방법
```bash
git pull origin main
# 실행 중인 프로세스 재시작 (선택사항)
```

### 영향 범위
- 자동 매매 시스템의 매수 로직에만 영향
- 매도 로직, 포트폴리오 조회 등 다른 기능에는 영향 없음
- 기존 DB 데이터 마이그레이션 불필요

---

## 🧪 테스트 권장사항

릴리즈 적용 후 다음 사항을 확인하세요:

1. **주문가능금액 확인**
   ```bash
   python test_account_balance.py
   ```
   - `available_amount` 값이 0이 아닌 실제 잔고 확인

2. **실제 매수 테스트**
   - 다음 스케줄 실행 시 로그 모니터링
   - 텔레그램 알림에서 "매수 불가" 메시지 사라짐 확인

3. **로그 확인**
   - `orchestrator_YYYYMMDD.log`에서 "주문가능금액" 로그 확인

---

## 📖 상세 문서

### 디버깅 과정
이번 버그는 다음과 같은 과정으로 발견 및 수정되었습니다:

1. **문제 인식**: 오후 스케줄 실행 후 텔레그램 "매수 불가" 알림 수신
2. **로그 분석**: `orchestrator_20251103.log` 확인
3. **API 응답 분석**: KIS API의 `output2` 응답 필드 전체 조회
4. **원인 파악**: `ord_psbl_cash` 필드가 0으로 반환됨을 확인
5. **해결책 적용**: `prvs_rcdl_excc_amt` 필드로 변경
6. **테스트**: 주문가능금액 1,031,195원 정상 표시 확인

### 관련 이슈
- Issue: 주문가능금액 0원 표시로 인한 매수 불가

---

## 🙏 기여자

- **@CBack83** - 버그 발견 및 문제 정의
- **Claude Code (AI Assistant)** - 디버깅, 수정, 테스트 및 문서화

---

## 📚 참고 자료

- [KIS OpenAPI 문서 - 잔고조회](https://apiportal.koreainvestment.com/)
- [이전 릴리즈 (v1.1.0)](https://github.com/CBack83/prism-insight/releases/tag/v1.1.0)

---

## 📦 다음 계획

향후 릴리즈에서 고려 중인 개선사항:

- [ ] 주문가능금액 계산 로직 추가 최적화 (예수금 vs 가수도 선택 옵션)
- [ ] 잔고 부족 시 부분 매수 기능 추가
- [ ] 실시간 잔고 모니터링 대시보드

---

**Full Changelog**: https://github.com/CBack83/prism-insight/compare/v1.1.0...v1.2.0

---

**생성일**: 2025-11-03
**작성자**: Claude Code (AI Assistant)
**커밋**: c61a8b5
